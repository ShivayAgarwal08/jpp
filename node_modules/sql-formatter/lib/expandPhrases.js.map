{"version":3,"file":"expandPhrases.js","names":["expandPhrases","phrases","flatMap","expandSinglePhrase","phrase","buildCombinations","parsePhrase","map","stripExtraWhitespace","text","replace","trim","type","items","parseAlteration","index","expectClosing","alterations","term","newIndex","parseConcatenation","push","Error","length","parseTerm","parseMandatoryBlock","parseOptionalBlock","word","test","node","reduce","stringCombinations","xs","ys","results","x","y"],"sources":["../src/expandPhrases.ts"],"sourcesContent":["/**\n * Performs expandSinglePhrase() on array\n */\nexport const expandPhrases = (phrases: string[]): string[] => phrases.flatMap(expandSinglePhrase);\n\n/**\n * Expands a syntax description like\n *\n *     \"CREATE [OR REPLACE] [TEMP|TEMPORARY] TABLE\"\n *\n * into an array of all possible combinations like:\n *\n *     [ \"CREATE TABLE\",\n *       \"CREATE TEMP TABLE\",\n *       \"CREATE TEMPORARY TABLE\",\n *       \"CREATE OR REPLACE TABLE\",\n *       \"CREATE OR REPLACE TEMP TABLE\",\n *       \"CREATE OR REPLACE TEMPORARY TABLE\" ]\n *\n * The [] and {} parenthesis can also be nested like\n *\n *     \"FOR [OF {UNIQUE | MANDATORY} TABLES]\"\n *\n * resulting in:\n *\n *     [ \"FOR\",\n *       \"FOR OF UNIQUE TABLES\",\n *       \"FOR OF MANDATORY TABLES\" ]\n */\nexport const expandSinglePhrase = (phrase: string): string[] =>\n  buildCombinations(parsePhrase(phrase)).map(stripExtraWhitespace);\n\nconst stripExtraWhitespace = (text: string) => text.replace(/ +/g, ' ').trim();\n\nconst parsePhrase = (text: string): Phrase => ({\n  type: 'mandatory_block',\n  items: parseAlteration(text, 0)[0],\n});\n\ntype Phrase = string | MandatoryBlock | OptionalBlock | Concatenation;\ntype Concatenation = { type: 'concatenation'; items: Phrase[] };\ntype MandatoryBlock = { type: 'mandatory_block'; items: Phrase[] };\ntype OptionalBlock = { type: 'optional_block'; items: Phrase[] };\n\nconst parseAlteration = (\n  text: string,\n  index: number,\n  expectClosing?: ']' | '}'\n): [Phrase[], number] => {\n  const alterations: Phrase[] = [];\n  while (text[index]) {\n    const [term, newIndex] = parseConcatenation(text, index);\n    alterations.push(term);\n    index = newIndex;\n    if (text[index] === '|') {\n      index++;\n    } else if (text[index] === '}' || text[index] === ']') {\n      if (expectClosing !== text[index]) {\n        throw new Error(`Unbalanced parenthesis in: ${text}`);\n      }\n      index++;\n      return [alterations, index];\n    } else if (index === text.length) {\n      if (expectClosing) {\n        throw new Error(`Unbalanced parenthesis in: ${text}`);\n      }\n      return [alterations, index];\n    } else {\n      throw new Error(`Unexpected \"${text[index]}\"`);\n    }\n  }\n  return [alterations, index];\n};\n\nconst parseConcatenation = (text: string, index: number): [Phrase, number] => {\n  const items: Phrase[] = [];\n  while (true) {\n    const [term, newIndex] = parseTerm(text, index);\n    if (term) {\n      items.push(term);\n      index = newIndex;\n    } else {\n      break;\n    }\n  }\n  return items.length === 1 ? [items[0], index] : [{ type: 'concatenation', items }, index];\n};\n\nconst parseTerm = (text: string, index: number): [Phrase, number] => {\n  if (text[index] === '{') {\n    return parseMandatoryBlock(text, index + 1);\n  } else if (text[index] === '[') {\n    return parseOptionalBlock(text, index + 1);\n  } else {\n    let word = '';\n    while (text[index] && /[A-Za-z0-9_ ]/.test(text[index])) {\n      word += text[index];\n      index++;\n    }\n    return [word, index];\n  }\n};\n\nconst parseMandatoryBlock = (text: string, index: number): [MandatoryBlock, number] => {\n  const [items, newIndex] = parseAlteration(text, index, '}');\n  return [{ type: 'mandatory_block', items }, newIndex];\n};\n\nconst parseOptionalBlock = (text: string, index: number): [OptionalBlock, number] => {\n  const [items, newIndex] = parseAlteration(text, index, ']');\n  return [{ type: 'optional_block', items }, newIndex];\n};\n\nconst buildCombinations = (node: Phrase): string[] => {\n  if (typeof node === 'string') {\n    return [node];\n  } else if (node.type === 'concatenation') {\n    return node.items.map(buildCombinations).reduce(stringCombinations, ['']);\n  } else if (node.type === 'mandatory_block') {\n    return node.items.flatMap(buildCombinations);\n  } else if (node.type === 'optional_block') {\n    return ['', ...node.items.flatMap(buildCombinations)];\n  } else {\n    throw new Error(`Unknown node type: ${node}`);\n  }\n};\n\nconst stringCombinations = (xs: string[], ys: string[]): string[] => {\n  const results: string[] = [];\n  for (const x of xs) {\n    for (const y of ys) {\n      results.push(x + y);\n    }\n  }\n  return results;\n};\n"],"mappings":"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"}